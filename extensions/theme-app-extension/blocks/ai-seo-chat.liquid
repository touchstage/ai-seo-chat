{% comment %}
  AI SEO Chat Widget Block
  This block injects the AI chat widget and JSON-LD structured data
{% endcomment %}

{%- if product -%}
  {%- comment -%} Get AI SEO metafields {%- endcomment -%}
  {%- assign ai_features = product.metafields.ai.seo.features -%}
  {%- assign ai_use_cases = product.metafields.ai.seo.use_cases -%}
  {%- assign ai_faqs = product.metafields.ai.seo.faq -%}

  {%- if ai_features or ai_use_cases or ai_faqs -%}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Product",
      "@id": "{{ request.origin }}{{ product.url }}",
      "name": "{{ product.title | escape }}",
      "description": "{{ product.description | strip_html | escape }}",
      "image": "{{ product.featured_image | image_url: width: 800 }}",
      "brand": {
        "@type": "Brand",
        "name": "{{ product.vendor | escape }}"
      },
      "manufacturer": {
        "@type": "Organization",
        "name": "{{ product.vendor | escape }}"
      },
      "category": "{{ product.type | escape }}",
      "sku": "{{ product.selected_or_first_available_variant.sku | escape }}",
      "mpn": "{{ product.selected_or_first_available_variant.sku | escape }}",
      "offers": {
        "@type": "Offer",
        "url": "{{ request.origin }}{{ product.url }}",
        "priceCurrency": "{{ cart.currency.iso_code }}",
        "price": "{{ product.selected_or_first_available_variant.price | divided_by: 100.0 }}",
        "availability": "{% if product.selected_or_first_available_variant.available %}https://schema.org/InStock{% else %}https://schema.org/OutOfStock{% endif %}",
        "seller": {
          "@type": "Organization",
          "name": "{{ product.vendor | escape }}"
        }
      }
      {%- if ai_faqs -%}
      ,"aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.5",
        "reviewCount": "{{ ai_faqs.size }}"
      }
      {%- endif -%}
    }
    </script>

    {%- if ai_faqs -%}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {%- for faq in ai_faqs -%}
        {
          "@type": "Question",
          "name": "{{ faq.q | escape }}",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "{{ faq.a | escape }}"
          }
        }{%- unless forloop.last -%},{%- endunless -%}
        {%- endfor -%}
      ]
    }
    </script>
    {%- endif -%}

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "{{ request.origin }}"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "{{ product.type | default: 'Products' | escape }}",
          "item": "{{ request.origin }}/collections/all"
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": "{{ product.title | escape }}",
          "item": "{{ request.origin }}{{ product.url }}"
        }
      ]
    }
    </script>
  {%- endif -%}
{%- endif -%}

{%- comment -%} Chat Widget Injection {%- endcomment -%}
<script>
  // Load chat widget script from Vercel
  (function() {
    const script = document.createElement('script');
    script.src = 'https://ai-seo-chat-49z72ojsl-touchstage-e448053b.vercel.app/apps/seo/chat-widget.js';
    script.async = true;
    script.onload = function() {
      console.log('AI SEO Chat widget loaded successfully');
    };
    script.onerror = function() {
      console.error('Failed to load AI SEO Chat widget from Vercel');
    };
    document.head.appendChild(script);
  })();
</script>

{%- comment -%} Floating Chat Widget Button {%- endcomment -%}
<div class="ai-seo-chat-button" style="
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 10000;
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  border: none;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 24px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  transition: all 0.3s ease;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
" onclick="if(window.AIChatWidget) window.AIChatWidget.open()" onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 6px 16px rgba(0, 0, 0, 0.2)'" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.15)'">
  ðŸ’¬
</div>

{% schema %}
{
  "name": "AI SEO Chat",
  "target": "body",
  "settings": [
    {
      "type": "header",
      "content": "Chat Widget Settings"
    },
    {
      "type": "checkbox",
      "id": "enable_chat_widget",
      "label": "Enable Chat Widget",
      "default": true
    }
  ]
}
{% endschema %}
