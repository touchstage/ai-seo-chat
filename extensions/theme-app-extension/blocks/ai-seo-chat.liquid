{% comment %}
  AI SEO Chat Widget Block
  This block injects the AI chat widget and JSON-LD structured data
{% endcomment %}

{%- if product -%}
  {%- comment -%} Get AI SEO metafields {%- endcomment -%}
  {%- assign ai_features = product.metafields.ai.seo.features -%}
  {%- assign ai_use_cases = product.metafields.ai.seo.use_cases -%}
  {%- assign ai_faqs = product.metafields.ai.seo.faq -%}

  {%- if ai_features or ai_use_cases or ai_faqs -%}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "Product",
      "@id": "{{ request.origin }}{{ product.url }}",
      "name": "{{ product.title | escape }}",
      "description": "{{ product.description | strip_html | escape }}",
      "image": "{{ product.featured_image | image_url: width: 800 }}",
      "brand": {
        "@type": "Brand",
        "name": "{{ product.vendor | escape }}"
      },
      "manufacturer": {
        "@type": "Organization",
        "name": "{{ product.vendor | escape }}"
      },
      "category": "{{ product.type | escape }}",
      "sku": "{{ product.selected_or_first_available_variant.sku | escape }}",
      "mpn": "{{ product.selected_or_first_available_variant.sku | escape }}",
      "offers": {
        "@type": "Offer",
        "url": "{{ request.origin }}{{ product.url }}",
        "priceCurrency": "{{ cart.currency.iso_code }}",
        "price": "{{ product.selected_or_first_available_variant.price | divided_by: 100.0 }}",
        "availability": "{% if product.selected_or_first_available_variant.available %}https://schema.org/InStock{% else %}https://schema.org/OutOfStock{% endif %}",
        "seller": {
          "@type": "Organization",
          "name": "{{ product.vendor | escape }}"
        }
      }
      {%- if ai_faqs -%}
      ,"aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": "4.5",
        "reviewCount": "{{ ai_faqs.size }}"
      }
      {%- endif -%}
    }
    </script>

    {%- if ai_faqs -%}
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": [
        {%- for faq in ai_faqs -%}
        {
          "@type": "Question",
          "name": "{{ faq.q | escape }}",
          "acceptedAnswer": {
            "@type": "Answer",
            "text": "{{ faq.a | escape }}"
          }
        }{%- unless forloop.last -%},{%- endunless -%}
        {%- endfor -%}
      ]
    }
    </script>
    {%- endif -%}

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "{{ request.origin }}"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "{{ product.type | default: 'Products' | escape }}",
          "item": "{{ request.origin }}/collections/all"
        },
        {
          "@type": "ListItem",
          "position": 3,
          "name": "{{ product.title | escape }}",
          "item": "{{ request.origin }}{{ product.url }}"
        }
      ]
    }
    </script>
  {%- endif -%}
{%- endif -%}

{%- comment -%} Chat Widget Injection {%- endcomment -%}
<script>
  // Load chat widget script
  (function() {
    const script = document.createElement('script');
    script.src = '{{ app.metafields.ai_seo_chat.widget_url | default: "/apps/seo/chat-widget.js" }}';
    script.async = true;
    script.onload = function() {
      console.log('AI SEO Chat widget loaded');
    };
    script.onerror = function() {
      console.error('Failed to load AI SEO Chat widget');
    };
    document.head.appendChild(script);
  })();
</script>

{%- comment -%} Optional: Inline Q&A Panel for Product Pages {%- endcomment -%}
{%- if product and ai_faqs and section.settings.show_qa_panel -%}
  <div class="ai-seo-qa-panel" style="margin: 2rem 0; padding: 1.5rem; background: #f8f9fa; border-radius: 8px;">
    <h3 style="margin: 0 0 1rem 0; color: #333;">Frequently Asked Questions</h3>
    <div class="ai-seo-qa-list">
      {%- for faq in ai_faqs limit: 5 -%}
        <details style="margin-bottom: 1rem; border: 1px solid #e1e5e9; border-radius: 4px;">
          <summary style="padding: 1rem; cursor: pointer; background: white; font-weight: 500;">
            {{ faq.q }}
          </summary>
          <div style="padding: 1rem; background: white; border-top: 1px solid #e1e5e9;">
            {{ faq.a }}
          </div>
        </details>
      {%- endfor -%}
    </div>
    <div style="margin-top: 1rem; text-align: center;">
      <button 
        onclick="if(window.AIChatWidget) window.AIChatWidget.open()"
        style="
          padding: 0.75rem 1.5rem;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          border-radius: 24px;
          cursor: pointer;
          font-size: 14px;
          font-weight: 500;
        "
      >
        Ask More Questions
      </button>
    </div>
  </div>
{%- endif -%}

{%- comment -%} Related Products Section {%- endcomment -%}
{%- if product and ai_features and section.settings.show_related_products -%}
  <div class="ai-seo-related-products" style="margin: 2rem 0;">
    <h3 style="margin: 0 0 1rem 0; color: #333;">You Might Also Like</h3>
    <div class="ai-seo-related-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
      {%- comment -%} This would be populated by the chat widget or a separate API call {%- endcomment -%}
      <div style="text-align: center; padding: 1rem; background: white; border: 1px solid #e1e5e9; border-radius: 8px;">
        <p style="margin: 0; color: #6c757d; font-size: 14px;">
          Related products will be suggested based on your AI SEO data
        </p>
        <button 
          onclick="if(window.AIChatWidget) window.AIChatWidget.sendMessage('Show me related products')"
          style="
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 16px;
            cursor: pointer;
            font-size: 12px;
          "
        >
          Get Suggestions
        </button>
      </div>
    </div>
  </div>
{%- endif -%}

{% schema %}
{
  "name": "AI SEO Chat",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Chat Widget Settings"
    },
    {
      "type": "checkbox",
      "id": "enable_chat_widget",
      "label": "Enable Chat Widget",
      "default": true
    },
    {
      "type": "header",
      "content": "Q&A Panel Settings"
    },
    {
      "type": "checkbox",
      "id": "show_qa_panel",
      "label": "Show Q&A Panel on Product Pages",
      "default": true,
      "info": "Displays AI-generated FAQs on product pages"
    },
    {
      "type": "header",
      "content": "Related Products Settings"
    },
    {
      "type": "checkbox",
      "id": "show_related_products",
      "label": "Show Related Products Section",
      "default": true,
      "info": "Displays AI-suggested related products"
    }
  ],

}
{% endschema %}
